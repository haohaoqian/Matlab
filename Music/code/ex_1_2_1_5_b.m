%1.2.1（5）合成《克罗地亚狂想曲》
clear all;
close all;
clc;

seq={[-100,...
    28,28,21,21,...
    23,23,16,16,...
    28,28,21,21,...
    23,23,16,16,...
    16,-100,16,-100,...
    16,16,16,16,16,...
    16,-100,16,-100,...
    16,16,16,16,16,...
    16,-100,9,-100,...
    11,11,4,4,...
    16,-100,9,-100,...
    11,11,4,4,...
    4,-100,4,-100,...
    4,4,4,-100,...
    4,-100,4,-100,...
    4,4,4,-100,...
    -100,-3,-100,-10,...
    -100,-8,-100,-100,...
    -100,-3,-100,-10,...
    -100,-100,-100,-100
    ],...
    [4,...
    23,24,21,23,24,21,16,17,14,16,17,14, ...
    18,20,16,16,11,12,9,11,12,9,...
    23,24,21,23,24,28,21,16,17,14,16,17,21,14,...
    18,20,16,16,11,12,9,11,12,9,...
    11,12,9,16,9,11,12,9,16,9,...
    11,12,9,9,8,9,9,11,12,9,...
    11,12,9,16,9,11,12,9,16,9,...
    11,12,9,9,8,9,9,11,12,9,...
    11,12,9,16,9,4,5,2,...
    6,8,4,4,-1,0,-3,-1,0,-3,...
    11,12,9,16,9,4,5,2,...
    6,8,4,4,-1,0,-3,-1,0,-3,...
    -1,0,-3,4,-3,-1,0,-3,4,-3,...
    -1,0,-3,-3,-4,-3,-3,-1,0,-3,...
    -1,0,-3,4,-3,-1,0,-3,4,-3,...
    -1,0,-3,-3,-4,-3,-3,-1,0,-3,...
    12,4,9,11,12,4,9,12,14,4,12,4,11,4,9,4,...
    11,4,8,9,11,4,7,11,12,4,11,4,9,4,16,4,...
    12,4,9,11,12,4,9,12,14,4,12,4,11,4,9,4,...
    16,4,8,4,12,4,11,4,9,4,16,4,9
    ],...
    [-3,-100,...
    -100,...
    -100,...
    -100,...
    -100,...
    -15,-100,-7,-100,...
    -8,-100,-15,-100,...
    -15,-100,-7,-100,...
    -8,-100,-15,-100,...
    -100,-8,-100,-15,...
    -100,-13,-100,-15,...
    -100,-8,-100,-15,...
    -100,-13,-100,-15,...
    -100,...
    -100,-13,-100,-15,...
    -100,...
    -100,-13,-100,-15,...
    -100,-8,-100,-15,...
    -100,-13,-100,-15,...
    -100,-8,-100,-15,...
    -20,-100,-3,-100,...
    ],...
    [-15,...
    -3,-7,...
    -8,-15,...
    -3,-7,...
    -8,-15,...
    -27,-19,...
    -20,-27,...
    -27,-19,...
    -20,-27,...
    -15,-12,-22,-19,...
    -20,-16,-27,-20,...
    -15,-12,-22,-19,...
    -20,-16,-27,-20,...
    -15,-15,-15,-3,-8,-15,-22,-22,-22,-10,-15,-22,...
    -20,-16,-27,-20,...
    -15,-15,-15,-3,-8,-15,-22,-22,-22,-10,-15,-22,...
    -20,-16,-27,-20,...
    -15,-12,-22,-19,...
    -20,-16,-27,-20,...
    -15,-12,-22,-19,...
    -32,-8,-100,...
    ]};%曲谱序列
time={[2,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.25,0.25,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.25,0.25,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5],...
    [2,...
    0.125,0.125,0.25,0.125,0.125,0.25,0.125,0.125,0.25,0.125,0.125,0.25,...
    0.125,0.125,0.25,0.25,0.125,0.125,0.25,0.125,0.125,0.5,...
    0.125,0.125,0.25,0.125,0.125,0.125,0.125,0.125,0.125,0.25,0.125,0.125,0.125,0.125,...
    0.125,0.125,0.25,0.25,0.125,0.125,0.25,0.125,0.125,0.5,...
    0.125,0.125,0.5,0.125,0.125,0.125,0.125,0.5,0.125,0.125,...
    0.125,0.125,0.25,0.25,0.125,0.25,0.125,0.125,0.125,0.5,...
    0.125,0.125,0.5,0.125,0.125,0.125,0.125,0.5,0.125,0.125,...
    0.125,0.125,0.25,0.25,0.125,0.25,0.125,0.125,0.125,0.5,...
    0.125,0.125,0.5,0.125,0.125,0.125,0.125,0.75,...
    0.125,0.125,0.25,0.25,0.125,0.125,0.25,0.125,0.125,0.5,...
    0.125,0.125,0.5,0.125,0.125,0.125,0.125,0.75,...
    0.125,0.125,0.25,0.25,0.125,0.125,0.25,0.125,0.125,0.5,...
    0.125,0.125,0.5,0.125,0.125,0.125,0.125,0.5,0.125,0.125,...
    0.125,0.125,0.25,0.25,0.125,0.25,0.125,0.125,0.125,0.5,...
    0.125,0.125,0.5,0.125,0.125,0.125,0.125,0.5,0.125,0.125,...
    0.125,0.125,0.25,0.25,0.125,0.25,0.125,0.125,0.125,0.5,...
    0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,...
    0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,...
    0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,...
    0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.125,0.5
    ],...
    [0.5,1.5,...
    2,...
    2,...
    2,...
    2,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    2,...
    0.5,0.5,0.5,0.5,...
    2,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.75,0.25,...
    ],...
    [2,...
    1,1,...
    1,1,...
    1,1,...
    1,1,...
    1,1,...
    1,1,...
    1,1,...
    1,1,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.25,0.125,0.125,0.125,0.125,0.25,0.25,0.125,0.125,0.125,0.125,0.25,...
    0.5,0.5,0.5,0.5,...
    0.25,0.125,0.125,0.125,0.125,0.25,0.25,0.125,0.125,0.125,0.125,0.25,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    0.5,0.5,0.5,0.5,...
    1,0.75,0.25
    ]};%时值(s)
overlap={[0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.2,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.2,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    ],...
    [0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.2,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.2,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1
    ],...
    [0.1,0.1,...
    0.1,...
    0.1,...
    0.1,...
    0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    ],...
    [0.1,...
    0.1,0.1,...
    0.1,0.1,...
    0.1,0.1,...
    0.1,0.1,...
    0.1,0.1,...
    0.1,0.1,...
    0.1,0.1,...
    0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.2,0.1,0.1,0.1,0.1,0.1,0.2,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.2,0.1,0.1,0.1,0.1,0.1,0.2,0.1,0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1,0.1,...
    0.1,0.1,0.1
    ]};%迭接时间(s)
amp={[1,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.85,0.85,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.85,0.85,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    ],...
    [1,...
    1,1,1,0.7,0.7,0.7,0.85,0.85,0.85,0.7,0.7,0.7,...
    1,1,1,0.7,0.7,0.7,0.85,0.85,0.85,0.7,...
    1,1,1,0.7,0.7,0.7,0.7,0.85,0.85,0.85,0.7,0.7,0.7,0.7,...
    1,1,1,0.7,0.7,0.7,0.85,0.85,0.85,0.7,...
    1,1,0.8,0.7,0.7,0.85,0.85,0.75,0.7,0.7,...
    1,1,0.8,0.7,0.7,0.8,0.8,0.7,0.7,0.7,...
    1,1,0.8,0.7,0.7,0.85,0.85,0.75,0.7,0.7,...
    1,1,0.8,0.7,0.7,0.8,0.8,0.7,0.7,0.7,...
    1,1,1,0.7,0.7,0.85,0.85,0.85,...
    1,1,1,0.7,0.7,0.7,0.85,0.85,0.85,0.7,...
    1,1,1,0.7,0.7,0.85,0.85,0.85,...
    1,1,1,0.7,0.7,0.7,0.85,0.85,0.85,0.7,...
    1,1,0.8,0.7,0.7,0.85,0.85,0.75,0.7,0.7,...
    1,1,1,0.7,0.7,0.8,0.85,0.85,0.85,0.7,...
    1,1,0.8,0.7,0.7,0.85,0.85,0.75,0.7,0.7,...
    1,1,1,0.7,0.7,0.8,0.85,0.85,0.85,0.7,...
    1,1,1,1,0.7,0.7,0.7,0.7,0.85,0.85,0.85,0.85,0.7,0.7,0.7,0.7,...
    1,1,1,1,0.7,0.7,0.7,0.7,0.85,0.85,0.85,0.85,0.7,0.7,0.7,0.7,...
    1,1,1,1,0.7,0.7,0.7,0.7,0.85,0.85,0.85,0.85,0.7,0.7,0.7,0.7,...
    1,1,1,1,0.7,0.7,0.7,0.7,0.85,0.85,0.85,0.85,0.7
    ],...
    [1,0.7,...
    1,...
    1,...
    1,...
    1,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,...
    1,0.7,0.85,0.7,...
    1,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    ],...
    [1,...
    1,0.85,...
    1,0.85,...
    1,0.85,...
    1,0.85,...
    1,0.85,...
    1,0.85,...
    1,0.85,...
    1,0.85,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,1,1,0.7,0.7,0.7,0.85,0.85,0.85,0.7,0.7,0.7,...
    1,0.7,0.85,0.7,...
    1,1,1,0.7,0.7,0.7,0.85,0.85,0.85,0.7,0.7,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.7,0.85,0.7,...
    1,0.85,0.7
    ]
    };%幅度

f0=311.13;%基准频率，降E调
freq=8000;%采样频率
output=zeros(1,freq*(sum(time{1})+1));%输出向量
for m=1:4
    position=1;%辅助指针
    for k=1:length(time{m})
        t=linspace(0,time{m}(k)+overlap{m}(k)-1/freq,freq*(time{m}(k)+overlap{m}(k)));%生成时间
        if seq{m}(k)~=-100%-100表示休止符
            temp=amp{m}(k)*sin(2*pi*f0*pow2(seq{m}(k)/12)*t);%生成乐音
            temp=temp+0.074*amp{m}(k)*sin(2*pi*2*f0*pow2(seq{m}(k)/12)*t);%高次谐波
            temp=temp+0.103*amp{m}(k)*sin(2*pi*3*f0*pow2(seq{m}(k)/12)*t);
            temp=temp+0.013*amp{m}(k)*sin(2*pi*4*f0*pow2(seq{m}(k)/12)*t);
            temp=temp+0.016*amp{m}(k)*sin(2*pi*5*f0*pow2(seq{m}(k)/12)*t);
            temp=temp+0.014*amp{m}(k)*sin(2*pi*6*f0*pow2(seq{m}(k)/12)*t);
            temp=temp+0.011*amp{m}(k)*sin(2*pi*7*f0*pow2(seq{m}(k)/12)*t);
            temp=temp+0.033*amp{m}(k)*sin(2*pi*8*f0*pow2(seq{m}(k)/12)*t);
            temp=temp+0.001*amp{m}(k)*sin(2*pi*9*f0*pow2(seq{m}(k)/12)*t);
            temp=temp+0.019*amp{m}(k)*sin(2*pi*10*f0*pow2(seq{m}(k)/12)*t);
        else
            temp=zeros(1,length(t));
        end
        cover=[-100*(t(1:0.1*time{m}(k)*freq-1)/time{m}(k)).^2+20*(t(1:0.1*time{m}(k)*freq-1)/time{m}(k))...
            ,1.15652*exp(-2*(t(0.1*time{m}(k)*freq:freq*(time{m}(k)+overlap{m}(k)))-0.1*time{m}(k))/(0.9*time{m}(k)+overlap{m}(k)))-0.15652];%生成包络
        output(position:position+freq*(time{m}(k)+overlap{m}(k))-1)=output(position:position+freq*(time{m}(k)+overlap{m}(k))-1)+cover.*temp;%添加乐音
        position=position+freq*time{m}(k);%移动指针 
    end
end
output=output/max(abs(output));%归一化
sound(output,freq);%播放
audiowrite('data/克罗地亚狂想曲.wav',output,freq)%保存